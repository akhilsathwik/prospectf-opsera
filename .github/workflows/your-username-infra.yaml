name: "your-username Infrastructure"

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      branch:
        description: 'Branch to use (default: prospectf500-app1-opsera)'
        required: false
        default: 'prospectf500-app1-opsera'
        type: string

env:
  AWS_REGION: eu-north-1
  APP_IDENTIFIER: your-username
  TENANT: opsera-se
  ENVIRONMENT: dev
  TF_WORKING_DIR: your-username-opsera/terraform
  TF_VAR_aws_region: eu-north-1

jobs:
  terraform:
    name: "Terraform Infrastructure"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS credentials
        run: |
          echo "=== AWS Identity ==="
          aws sts get-caller-identity
          echo ""
          echo "=== AWS Region ==="
          echo "Region: ${{ env.AWS_REGION }}"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Create S3 backend bucket if not exists
        continue-on-error: true
        run: |
          BUCKET_NAME="${{ env.APP_IDENTIFIER }}-tfstate"
          TABLE_NAME="${{ env.APP_IDENTIFIER }}-tfstate-lock"
          
          echo "=== Checking S3 backend bucket: $BUCKET_NAME ==="
          
          # Create S3 bucket for state
          if ! aws s3 ls "s3://$BUCKET_NAME" 2>/dev/null; then
            echo "Creating S3 bucket: $BUCKET_NAME"
            aws s3 mb "s3://$BUCKET_NAME" --region ${{ env.AWS_REGION }}
            aws s3api put-bucket-versioning --bucket "$BUCKET_NAME" --versioning-configuration Status=Enabled
            aws s3api put-bucket-encryption --bucket "$BUCKET_NAME" --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'
            echo "✓ S3 bucket created successfully"
          else
            echo "✓ S3 bucket already exists"
          fi
          
          # Create DynamoDB table for locking
          echo "=== Checking DynamoDB lock table: $TABLE_NAME ==="
          if ! aws dynamodb describe-table --table-name "$TABLE_NAME" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "Creating DynamoDB table: $TABLE_NAME"
            aws dynamodb create-table \
              --table-name "$TABLE_NAME" \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --region ${{ env.AWS_REGION }}
            echo "Waiting for DynamoDB table to be active..."
            aws dynamodb wait table-exists --table-name "$TABLE_NAME" --region ${{ env.AWS_REGION }}
            echo "✓ DynamoDB table created successfully"
          else
            echo "✓ DynamoDB table already exists"
          fi

      - name: Terraform Init
        run: |
          BUCKET_NAME="${{ env.APP_IDENTIFIER }}-tfstate"
          KEY="terraform.tfstate"
          
          terraform init \
            -backend-config="bucket=$BUCKET_NAME" \
            -backend-config="key=$KEY" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ env.APP_IDENTIFIER }}-tfstate-lock" \
            -upgrade

      - name: Terraform Import Existing Resources (if any)
        if: github.event.inputs.action == 'apply'
        continue-on-error: true
        run: |
          # Import ArgoCD cluster if exists
          ARGOCD_CLUSTER="argocd-${{ env.AWS_REGION }}"
          if aws eks describe-cluster --name "$ARGOCD_CLUSTER" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            terraform import aws_eks_cluster.argocd "$ARGOCD_CLUSTER" || echo "Already imported or not in state"
          fi

          # Import workload cluster if exists
          CLUSTER_ENV="nonprod"
          WORKLOAD_CLUSTER="${{ env.TENANT }}-${{ env.AWS_REGION }}-${CLUSTER_ENV}"
          if aws eks describe-cluster --name "$WORKLOAD_CLUSTER" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            terraform import aws_eks_cluster.workload "$WORKLOAD_CLUSTER" || echo "Already imported or not in state"
          fi

          # Import ECR repos if exist
          ECR_BACKEND="${{ env.TENANT }}/${{ env.APP_IDENTIFIER }}-backend"
          ECR_FRONTEND="${{ env.TENANT }}/${{ env.APP_IDENTIFIER }}-frontend"
          
          if aws ecr describe-repositories --repository-names "$ECR_BACKEND" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            terraform import aws_ecr_repository.backend "$ECR_BACKEND" || echo "Already imported"
          fi
          
          if aws ecr describe-repositories --repository-names "$ECR_FRONTEND" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            terraform import aws_ecr_repository.frontend "$ECR_FRONTEND" || echo "Already imported"
          fi

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Format Check
        run: terraform fmt -check

      - name: Terraform Plan
        if: github.event.inputs.action == 'plan' || github.event.inputs.action == 'apply'
        run: |
          terraform plan \
            -var="tenant_name=${{ env.TENANT }}" \
            -var="app_name=${{ env.APP_IDENTIFIER }}" \
            -var="app_env=${{ env.ENVIRONMENT }}" \
            -var="app_region=${{ env.AWS_REGION }}" \
            -var="cluster_env=nonprod" \
            -out=tfplan

      - name: Terraform Plan Output
        if: github.event.inputs.action == 'plan'
        run: |
          echo "=== Terraform Plan Summary ==="
          terraform show -no-color tfplan | head -100

      - name: Terraform Apply
        if: github.event.inputs.action == 'apply'
        run: |
          terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        run: |
          terraform destroy \
            -var="tenant_name=${{ env.TENANT }}" \
            -var="app_name=${{ env.APP_IDENTIFIER }}" \
            -var="app_env=${{ env.ENVIRONMENT }}" \
            -var="app_region=${{ env.AWS_REGION }}" \
            -var="cluster_env=nonprod" \
            -auto-approve

      - name: Output Infrastructure Details
        if: github.event.inputs.action == 'apply'
        run: |
          echo "=== Infrastructure Created ==="
          terraform output -json
